#!/bin/bash

set -o nounset -o pipefail -o errexit

SCRIPT_DIR=$(readlink -f "$0" | xargs dirname)
TOOLS=${TOOLS-$(readlink -f "$SCRIPT_DIR/../tools")}

. <("$TOOLS/build-info" -e)

ARTIFACTS=${ARTIFACTS-$1}

TMP=$(mktemp -d)
trap 'rm -rf $TMP' EXIT
ASSETS=$TMP/assets
mkdir -p "$ASSETS"

unzip "$ARTIFACTS/PKGBUILD.$BUILD_GIT_REF.zip" -d "$ASSETS"

unzip "$ARTIFACTS/source-package.$BUILD_GIT_REF.ubuntu2204.zip" -d "$TMP"
for f in "$TMP/"*"$BUILD_VERSION.tar"; do
    mv "$f" "$ASSETS/$(sed 's/.tar$/.ubuntu.tar/' <<< "$(basename "$f")")"
done

gh release create \
    --target=$BUILD_GIT_REF \
    "v$BUILD_VERSION" \
    "$ASSETS"/*
