#!/bin/bash

set -o nounset -o pipefail -o errexit

SCRIPT_DIR=$(readlink -f "$0" | xargs dirname)

DRY_RUN=
YES=
RUNTIME=
BUILD=
CHECK=
ARCH=${ARCH-}
while getopts "nyrbcA-" OPT; do
    case $OPT in
        n) DRY_RUN=1 ;;
        y) YES=1 ;;
        r) RUNTIME=1 ;;
        b) BUILD=1 ;;
        c) CHECK=1 ;;
        A) ARCH=$OPTARG ;;
        -) break ;;
        ?) exit 2 ;;
    esac
done
shift $((OPTIND-1))

LUA_VER=5.4
PYTHON_VER=3

if grep -cq '^ubuntu' <<< "$ARCH" || command -v apt-get > /dev/null; then
    PKGS=()

    if [ -n "$RUNTIME" ]; then
        PKGS+=(libcap2)
        PKGS+=("lua$LUA_VER")
        PKGS+=("python$PYTHON_VER")
    fi

    if [ -n "$BUILD" ]; then
        PKGS+=(make wget gcc bison flex libcap-dev)
        PKGS+=("liblua$LUA_VER-dev")
        PKGS+=("libpython$PYTHON_VER-dev")
    fi

    if [ -n "$CHECK" ]; then
        PKGS+=(uuid-runtime jq)
    fi

    if [ -n "$DRY_RUN" ]; then
        echo "${PKGS[@]}"
    elif [ -n "$YES" ]; then
        apt-get install -y "${PKGS[@]}"
    else
        apt-get install "${PKGS[@]}"
    fi
elif [ "$ARCH" = "archlinux" ] || command -v pacman > /dev/null; then
    PKGBUILD=$SCRIPT_DIR/archlinux/PKGBUILD.template
    PKGS=()

    if [ -n "$RUNTIME" ]; then
        . <(grep '^depends' "$PKGBUILD" | sed 's/^\s*\w\+\s*/PKGS+/')
    fi

    if [ -n "$BUILD" ]; then
        . <(grep '^makedepends' "$PKGBUILD" | sed 's/^\s*\w\+\s*/PKGS+/')
    fi

    if [ -n "$CHECK" ]; then
        . <(grep '^checkdepends' "$PKGBUILD" | sed 's/^\s*\w\+\s*/PKGS+/')
    fi

    if [ -n "$DRY_RUN" ]; then
        echo "${PKGS[@]}"
    elif [ -n "$YES" ]; then
        pacman -S --noconfirm "${PKGS[@]}"
    else
        pacman -S "${PKGS[@]}"
    fi
else
    echo 1>&2 "I don't know how to install dependencies on this system"
    exit 1
fi
