#!/bin/bash

set -o nounset -o pipefail -o errexit

INSTALL=${INSTALL-}
SUDO=${SUDO-}
while getopts "is:-" OPT; do
    case $OPT in
        i) INSTALL=1 ;;
        s) SUDO=$OPTARG ;;
        -) break ;;
        ?) exit 2 ;;
    esac
done
shift $((OPTIND-1))

if ! command -v dpkg-checkbuilddeps; then
    if [ -n "$INSTALL" ]; then
        $SUDO apt-get install -y --no-install-recommends dpkg-dev
    else
        echo 1>&2 "unable to proceed without dpkg-dev package"
        exit 1
    fi
fi

PKGS=($( (dpkg-checkbuilddeps 2>&1 || true) \
    | grep "Unmet build dependencies" \
    | sed 's/dpkg-checkbuilddeps:\serror:\sUnmet build dependencies: //g' \
    | sed 's/[\(][^)]*[\)] //g'))

[ "${#PKGS[@]}" -eq 0 ] && exit 0

if [ -n "$INSTALL" ]; then
    set +o errexit
    $SUDO apt-get install -y --no-install-recommends "${PKGS[@]}"
    EC=$?
    set -o errexit
    if [ "$EC" -ne 0 ]; then
        echo 1>&2 "unable to install missing dependencies: ${PKGS[@]}"
        if [ -z "$SUDO" ]; then
            echo 1>&2 "try setting SUDO environment variable (e.g. SUDO=sudo) or install packages manually"
        fi
        exit 1
    fi
else
    echo "${PKGS[@]}"
fi
