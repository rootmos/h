#!/bin/bash

set -o nounset -o pipefail -o errexit

SCRIPT_DIR=$(readlink -f "$0" | xargs dirname)
TOOLS=${TOOLS-$(readlink -f "$SCRIPT_DIR/../tools")}

. <("$TOOLS/build-info" -e)

ARTIFACTS=${ARTIFACTS-$1}

ASSETS=$(mktemp -d)
trap 'rm -rf $ASSETS' EXIT

unzip "$ARTIFACTS/PKGBUILD.$BUILD_GIT_REF.zip" -d "$ASSETS"

cp -v "$ARTIFACTS/source-package.$BUILD_GIT_REF.ubuntu2204.zip" \
    "$ASSETS/source-package.$BUILD_VERSION.zip"

gh release create \
    --target=$BUILD_GIT_REF \
    "v$BUILD_VERSION" \
    "$ASSETS"/*
